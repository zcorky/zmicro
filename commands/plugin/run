#!/bin/bash

# command_path=$ZMICRO_PLUGINS_PATH/$1
# run $ZMICRO_COMMANDS_PATH $ZMICRO_PLUGINS_PATH $@

# echo "in plugin: $@"

plugin_name=$1
plugin_command=${@:2}

if [ -z "$plugin_name" ]; then
  log_error "plugin name is required"
  exit 1
fi

if [ -z $ZMICRO_PLUGINS_PATH ]; then
  ZMICRO_PLUGINS_PATH=$ZMICRO_HOME/plugins
fi

plugin_base_path=$ZMICRO_PLUGINS_PATH/$plugin_name
plugin_config_path=$plugin_base_path/config
plugin_commands_path=$plugin_base_path/commands

# echo "plugin_commands_path: $plugin_commands_path"
# echo "plugin_name: $plugin_name"
# echo "plugin_command: $plugin_command"
# before run
#   1. load config
load_config $plugin_config_path
#   2. load user config
load_user_config

# internal commands
if [ "$plugin_command" = "version" ]; then
  zmicro plugin version $plugin_name
elif [ "$plugin_command" = "description" ]; then
  zmicro plugin description $plugin_name
elif [ "$plugin_command" = "dependencies" ]; then
  zmicro plugin dependencies $plugin_name
elif [ "$plugin_command" = "update" ]; then
  zmicro plugin update $plugin_name
elif [ "$(array_first_element $plugin_command)" = "fn" ]; then
  # zmicro plugin run daemon fn daemon_list => zmicro plugin fn daemon daemon_list
  # zdaemon fn daemon_list => zmicro plugin fn daemon daemon_list
  zmicro plugin fn $plugin_name ${plugin_command:2}
else
  # load core utils
  plugin_load_core $plugin_name

  run $plugin_commands_path "-" $plugin_command
fi